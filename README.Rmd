---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# chewie

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

  *Still in a developmental phase - only level-2A data available at present.*

The goal of chewie is to make downloading GEDI data as fast and as simple as 
possible. Here is a quick summary of features that enables {chewie} to achieve 
this:

-  Support for spatial filtering of swaths that intersect an area of interest 
and not only by bounding box; this can frequently reduce the amount of 
irrelevant data that is downloaded.

- GEDI is provided in large files in the h5 format. Whilst performative, the 
disk space required to store these files is large ~ 2-3GB per GEDI 2A file. 
This package downloads the data (as we know of no way to stream these files) and 
then converts them to parquet format which have a file size of  100-200MB per
file. Further, the parquet format enables dynamic filtering of the data without
having to load the entire file into memory - this includes spatial filtering 
(at least crudely for now based on bounding box until geoparquet is more widely
supported).

- In terms of "ease of use" the package is designed to be as simple as possible.
with the main feature here being the automated caching of files in a central 
location. This means that once a file has been downloaded it will not be
downloaded again even if working in a different project (it is also possible to
specify a different cache location for each project). 

- The scope of this package is intended to be deilibertly narrow. It is not 
intended to include functionality for post processing or modelling.


TO DO:

- [ ] Add conversion methods for 1B, 2B and 4A data

- [ ] Add a `chewie_show` method to plot footprints

- [ ] Add a functionality to get level 4a data
  
- [ ] Add cache reporting to `chewie_health_check` - i.e. n files in cache, 
size of cache, etc.

- [ ] refactor to use {collapse} instead of {data.table} or maybe just use dplyr
as this really has to be a "depends" anyway and we're not really making the most
of the data.table functionality as it stands because we are using arrow for the
data qurying etc. 

- [ ] Currently a sort of bug exists whereby if you drop the lat long columns
after running  `geb_gedi`, then the `collect_gedi` function will fail. Needs a
little thought or maybe just a better error message...

-[ ] write tests...


## Installation

You can install the development version of chewie like so:

``` r
# install.packages("pak")
pak::pkg_install("Permian-Global-Research/chewie")
```

## Example
```{r find-data}
library(chewie)

# chewie_creds() # to set up your credentials
# chewie_health_check() # to check your credentials and cache setup.
nc <- system.file("gpkg", "nc.gpkg", package = "sf")
hw <- subset(sf::read_sf(nc), NAME == "Haywood")

gedi_2a_search <- find_gedi(hw,
  gedi_product = "2A",
  date_start = "2022-12-31"
)

print(gedi_2a_search)

swaths_img <- chewie_show(gedi_2a_search,
  time_group = "month",
  interactive = FALSE
)
```
![map](inst/imgs/map.png)

```{r collect-data}
gedi_2a_sf <- grab_gedi(gedi_2a_search) |>
  dplyr::filter(
    quality_flag == 0,
    degrade_flag == 0
  ) |>
  collect_gedi(find = gedi_2a_search)

print(gedi_2a_sf)

plot(gedi_2a_sf[0], axes = TRUE, col = "#43b37f")
plot(sf::st_transform(hw[0], sf::st_crs(gedi_2a_sf)), add = TRUE)
```


## Other relevant packages
- [{rGEDI}](https://github.com/carlos-alberto-silva/rGEDI) provides the ability
download GEDI data but also a great deal of additional functionality for 
visualisation, post processing and modelling.

- [{GEDI4R}](https://github.com/VangiElia/GEDI4R) which similiarly provides a 
suit of tools for downloading, visualising and modelling GEDI data, but with a
focus on the 4A product.

Both of these packages have been a great source of inspiration for this package
we would like to thank the authors for their great work! 